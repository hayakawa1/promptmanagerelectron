# Electron Image Viewer 仕様書

## 1. 概要

本アプリケーションは、Electron フレームワークを用いて開発されたローカル環境向けの画像ビューアおよび管理ツールです。指定されたフォルダ内の画像をスキャンしてデータベースに登録し、効率的な閲覧、検索、管理機能を提供します。

## 2. 主要機能

### 2.1. フォルダスキャン

*   **機能**: ユーザーが指定したフォルダ内（サブフォルダ含む）の画像ファイルをスキャンし、画像情報をデータベースに登録します。
*   **トリガー**:
    *   アプリケーションメニューの「ファイル」>「フォルダをスキャン」を選択。
*   **処理内容**:
    *   指定されたフォルダから対応画像ファイル（PNG, JPG, JPEG, WEBP, GIF, BMP, TIFF）を検索します。
    *   各画像ファイルについて以下の情報を取得し、データベースに保存します。
        *   ファイルパス (`original_path`)
        *   ファイル名 (`file_name`)
        *   フォルダパス (`folder_path`)
        *   ファイルサイズ (`file_size`)
        *   OSによるファイル作成日時 (`created_at_os`)
        *   画像の幅 (`width`) と高さ (`height`)
        *   画像フォーマット (`format`)
        *   画像メタデータ詳細 (JSON形式, `metadata_json`) - `sharp` ライブラリから取得
        *   PNG テキストチャンク情報 (`png_info`) - PNG画像の場合のみ、`tEXt`, `iTXt`, `zTXt` チャンクから抽出
        *   登録日時 (`registered_at`)
    *   データベース登録時には `INSERT OR IGNORE` を使用し、既に登録済みのファイルパスの画像はスキップします。
    *   スキャン中はステータスバーに進捗状況（処理ファイル数、追加数、スキップ数、エラー数）を表示します。
    *   スキャン完了後、画像グリッドとフィルター（フォルダ、PNG単語）を更新します。

### 2.2. 画像表示

*   **機能**: データベースに登録された画像をサムネイル形式でグリッド表示します。
*   **UI**:
    *   レスポンシブなグリッドレイアウト (`#image-grid`) を採用し、ウィンドウサイズに応じて列数が自動調整されます。
    *   各画像は固定の高さで表示され、`object-fit: cover` でアスペクト比を維持しつつ表示領域を埋めます。
    *   画像にマウスオーバーするとわずかに拡大するエフェクトがあります。
    *   画像の `title` 属性には、ファイル名、ID、メモが表示されます。
*   **遅延読み込み**:
    *   一度にすべての画像を表示せず、画面下部までスクロールすると次の画像セットを自動的に読み込む無限スクロールを実装しています (`PAGE_SIZE` 分ずつ)。
*   **画像読み込み**: ローカルファイルパスへの直接アクセスを避け、メインプロセスで登録された `atom://` カスタムプロトコル経由で安全に画像を表示します。

### 2.3. 画像選択

*   **機能**: グリッド表示された画像を選択する機能を提供します。
*   **操作方法**:
    *   **単一選択**: 画像をクリックします。
    *   **複数選択（追加/解除）**: Ctrlキー（Windows/Linux）またはCmdキー（macOS）を押しながら画像をクリックします。
    *   **範囲選択**: 最初に画像をクリックした後、Shiftキーを押しながら別の画像をクリックすると、その間のすべての画像が選択されます。
*   **UI**:
    *   選択された画像には青い枠線が表示されます (`selected` クラス)。
    *   ステータスバーには選択中の画像件数が表示されます。
    *   画像が選択されている間のみ、メモ入力欄、メモ更新ボタン、削除ボタン、エクスポートボタンが有効になります。

### 2.4. 画像モーダル表示

*   **機能**: 画像をダブルクリックすると、モーダルウィンドウで原寸大表示します。
*   **UI**:
    *   モーダルは画面中央に表示され、背景は半透明の黒になります (`#modal-overlay`)。
    *   画像はモーダル内で可能な限り大きく表示されます（最大幅/高さを制限）。
    *   モーダル下部には、その画像の PNG テキストチャンク情報 (`png_info`) が表示されます。情報がない場合はその旨が表示されます。
    *   モーダルの右上の「×」ボタン、またはモーダル外の背景をクリックするとモーダルを閉じます。

### 2.5. フィルタリングと検索

*   **機能**: 表示する画像を絞り込むためのフィルターと検索機能を提供します。
*   **UI**:
    *   **フォルダフィルター**: ツールバーにあるドロップダウン (`#folder-filter`) で、データベースに登録されている特定のフォルダを選択すると、そのフォルダ内の画像のみが表示されます。「全てのフォルダ」を選択するとフィルターが解除されます。ドロップダウンの内容はデータベースから動的に生成されます。
    *   **PNG 単語フィルター**: ツールバーにあるドロップダウン (`#png-word-filter`) で、データベース内の PNG テキストチャンク情報に含まれるユニークな単語を選択すると、その単語を含む画像のみが表示されます。「全てのPNG単語」を選択するとフィルターが解除されます。ドロップダウンの内容はデータベースから動的に生成されます。
    *   **キーワード検索**: ツールバーにある検索ボックス (`#search-input`) にキーワードを入力すると、ファイル名、メモ、PNG テキストチャンク情報にそのキーワードを含む画像が検索されます。入力後 500ms のデバウンス後に検索が実行されます。
*   **連携**: フィルターや検索条件を変更すると、画像グリッドが再読み込みされ、該当する画像のみが表示されます。無限スクロールも適用されたフィルター/検索条件に基づいて動作します。ステータスバーには現在のフィルター/検索条件と表示件数が表示されます。

### 2.6. 画像管理アクション

*   **機能**: 選択した画像に対して各種管理操作を行います。
*   **UI**: ツールバー右側に配置されたボタンと入力欄で操作します。画像が選択されている場合のみ有効になります。
    *   **メモ入力/更新**:
        *   入力欄 (`#memo-input`) にテキストを入力し、「メモを更新」ボタン (`#update-memo-button`) をクリックすると、選択されているすべての画像に同じメモが一括で設定（または上書き）されます。
        *   成功すると、画像の `title` 属性（マウスオーバーで表示）も更新されます。
    *   **削除**:
        *   「選択画像を削除」ボタン (`#delete-selected-button`) をクリックすると、確認ダイアログが表示されます。
        *   「はい」を選択すると、選択された画像がデータベースから削除されます。**注意: 元の画像ファイルは削除されません。**
        *   成功すると、グリッド表示からも該当する画像が削除されます。
    *   **エクスポート**:
        *   「選択画像を保存」ボタン (`#export-selected-button`) をクリックすると、保存先のフォルダを選択するダイアログが表示されます。
        *   フォルダを選択すると、選択されているすべての画像ファイルが指定されたフォルダにコピーされます。

## 3. 技術要素

*   **フレームワーク**: Electron
*   **言語**: JavaScript (Node.js)
*   **データベース**: SQLite (ライブラリ: `better-sqlite3`)
*   **主要ライブラリ**:
    *   `electron`: アプリケーションのコア機能
    *   `better-sqlite3`: SQLite データベース操作
    *   `glob`: ファイルパスのパターンマッチング（フォルダスキャン用）
    *   `sharp`: 高速な画像処理（メタデータ取得用）
    *   `png-chunks-extract`: PNG ファイルのチャンクデータ抽出
    *   `zlib`: zTXt/iTXt チャンクの展開
*   **プロセス**: メインプロセス (`main.js`) とレンダラープロセス (`renderer.js`) で構成され、`preload.js` と IPC (Inter-Process Communication) を介して通信します。
*   **UI**: HTML, CSS, JavaScript (DOM操作)

## 4. データ構造

### 4.1. データベース (`file_db.sqlite`)

*   **テーブル**: `images`
    *   `id` (INTEGER PRIMARY KEY AUTOINCREMENT): 一意なID
    *   `original_path` (TEXT UNIQUE NOT NULL): 画像ファイルのフルパス
    *   `file_name` (TEXT NOT NULL): ファイル名
    *   `folder_path` (TEXT NOT NULL): ファイルが存在するフォルダのパス
    *   `file_size` (INTEGER): ファイルサイズ (バイト)
    *   `created_at_os` (INTEGER): OSが記録するファイル作成日時 (Unix タイムスタンプ)
    *   `width` (INTEGER): 画像の幅 (ピクセル)
    *   `height` (INTEGER): 画像の高さ (ピクセル)
    *   `format` (TEXT): 画像フォーマット (例: 'png', 'jpeg')
    *   `metadata_json` (TEXT): `sharp` で取得した詳細なメタデータ (JSON文字列)
    *   `png_info` (TEXT): 抽出された PNG テキストチャンク情報 (複数行テキスト)
    *   `registered_at` (DATETIME DEFAULT CURRENT_TIMESTAMP): データベースへの登録日時
    *   `memo` (TEXT): ユーザーが付与したメモ
    *   `phash` (TEXT): (将来用) 知覚ハッシュ
    *   `parameter_hash` (TEXT): (将来用) パラメータハッシュ
*   **インデックス**: `idx_folder_path` (on `folder_path`), `idx_file_name` (on `file_name`)

## 5. 注意事項・制限事項

*   本アプリケーションはローカルファイルを対象としており、ネットワーク上の画像は扱えません。
*   画像の削除機能はデータベースからのレコード削除のみであり、ファイルシステム上のファイルは削除しません。
*   非常に大量の画像を扱う場合、パフォーマンスに影響が出る可能性があります（特に初回スキャン時）。
*   PNG テキストチャンクの抽出・表示は、主要な形式 (tEXt, iTXt, zTXt) のデコードに対応していますが、すべてのエンコーディングや圧縮形式に完全に対応しているわけではありません。 